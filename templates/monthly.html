{% load number_format %}

<html lang="en" class="h-full" style="font-size: 14px;"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly - FinTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Golos Text', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .btn {
      transition: all 0.2s;
      font-weight: 500;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
    }

    .btn-primary {
      background: #7367f0;
      color: white;
    }

    .btn-primary:hover {
      background: #5f54d6;
    }

    .btn-danger {
      background: #ea5455;
      color: white;
    }

    .btn-danger:hover {
      background: #d63939;
    }

    .btn-secondary {
      background: #82868b;
      color: white;
    }

    .btn-secondary:hover {
      background: #6e7175;
    }

    .btn-success {
      background: #28c76f;
      color: white;
    }

    .btn-success:hover {
      background: #24b364;
    }

    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d8d6de;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: #7367f0;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      background: #f8f7fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: #5e5873;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #ebe9f1;
      font-size: 14px;
    }

    .table tr:hover {
      background: #fafafa;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #5e5873;
      font-size: 0.9em;
    }

    .dots-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      color: #6e6b7b;
      font-size: 20px;
      font-weight: bold;
      transition: color 0.2s;
      line-height: 1;
    }

    .dots-btn:hover {
      color: #5e5873;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ebe9f1;
    }

    .tab-btn {
      padding: 12px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #82868b;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-size: 0.95em;
    }

    .tab-btn.active {
      color: #7367f0;
      border-bottom-color: #7367f0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .action-menu {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 100px;
      top: 100%;
      right: 0;
    }

    .action-menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s;
    }

    .action-menu button:hover {
      background: #f5f3ff;
    }

    .action-menu button:first-child {
      border-radius: 4px 4px 0 0;
    }

    .action-menu button:last-child {
      border-radius: 0 0 4px 4px;
      color: red;
      border-top: 1px solid #eee;
    }

    /* Mobile Responsive Navbar */
    @media (max-width: 768px) {
      html { font-size: 12px; }
      
      div[style*="display: flex; align-items: center; gap: 32px"] {
        width: 100% !important;
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      nav[style*="display: flex; gap: 8px"] {
        width: 100% !important;
        flex-wrap: wrap !important;
        gap: 6px !important;
      }
      
      nav[style*="display: flex; gap: 8px"] a {
        flex: 1 !important;
        min-width: 70px !important;
        padding: 8px 10px !important;
        font-size: 11px !important;
      }
      
      @media (max-width: 600px) {
        nav[style*="display: flex; gap: 8px"] a {
          padding: 8px 6px !important;
          font-size: 0 !important;
        }
        
        nav[style*="display: flex; gap: 8px"] a svg {
          display: inline-block;
          width: 18px !important;
          height: 18px !important;
        }
        
        form[method="POST"][action*="logout"] button {
          width: 100% !important;
          padding: 8px !important;
          font-size: 0 !important;
        }
        
        form[method="POST"][action*="logout"] button svg {
          display: inline-block;
          width: 18px !important;
          height: 18px !important;
          margin-right: 0 !important;
        }
      }
    }

    @media (max-width: 480px) {
      html { font-size: 11px !important; }
    }
  </style>
</head>
<body class="h-full" style="background: rgb(248, 247, 250); margin: 0px; color: rgb(94, 88, 115); font-family: 'Golos Text', sans-serif;">
  <div id="app" style="width: 100%; height: 100%; overflow: auto;">
    <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">

      <div style="width: 100%; padding: 16px 32px; border-bottom: 1px solid #ebe9f1; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.04);">
        <div style="display: flex; align-items: center; gap: 32px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #7367f0, #5f54d6); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2em;">F</div>
            <h2 style="margin: 0; font-size: 1.3em; font-weight: 700; color: #5e5873;">FinTrack</h2>
          </div>
          <nav style="display: flex; gap: 8px;">
            <a href="{% url 'dashboard' %}" class="btn" style="background: transparent; color: #5e5873; text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
            {% if request.user.is_staff %}
            <a href="{% url 'users' %}" class="btn" style="background: transparent; color: #5e5873; text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Users
            </a>
            <a href="{% url 'monthly' %}" class="btn" style="background: #7367f0; color: white; text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Employees
            </a>
            <a href="{% url 'warehouse' %}" class="btn" style="background: transparent; color: #5e5873; text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
              Warehouse
            </a>
            {% endif %}
          </nav>
        </div>
        <form method="POST" action="{% url 'logout' %}" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="display: flex; align-items: center; gap: 6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </button>
        </form>
      </div>

      <div style="flex: 1; padding: 24px; overflow-y: auto;">
        <div style="max-width: 1400px; margin: 0 auto;">
          <div style="margin-bottom: 24px;">
            <h1 style="font-size: 2em; margin: 0; color: #5e5873; font-weight: 700;">Employee Earnings</h1>
            <p style="color: #82868b; margin-top: 4px;">Manage employee earnings and payments</p>
          </div>

          <div class="card" style="padding: 24px;">
            <div class="tabs">
              <button class="tab-btn active" onclick="switchTab('list')">Employees</button>
              <button class="tab-btn" onclick="switchTab('details')">Details</button>
            </div>

            <!-- Tab: Employees List -->
            <div id="list" class="tab-content active">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                <h2 style="font-size: 1.3em; margin: 0; font-weight: 600; color: #5e5873;">All Employees</h2>
                <button onclick="openEmployeeModal()" class="btn btn-primary">+ Add Employee</button>
              </div>

              <div style="overflow-x: auto;">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Position</th>
                      <th>Balance</th>
                      <th style="width: 50px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="employeesBody">
                    <tr style="text-align: center; color: #82868b;">
                      <td colspan="4">Loading employees...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tab: Employee Details -->
            <div id="details" class="tab-content">
              <div style="padding: 20px;">
                <div style="text-align: center; color: #82868b;">
                  <p style="margin: 0;">Select an employee from the list to view details</p>
                </div>
              </div>
              <div id="employeeDetailsContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <div>
                    <h2 style="font-size: 1.3em; margin: 0; font-weight: 600; color: #5e5873;" id="employeeDetailName"></h2>
                    <p style="color: #82868b; margin: 4px 0 0 0;" id="employeeDetailPosition"></p>
                  </div>
                  <button onclick="closeEmployeeDetail()" class="btn btn-secondary">← Back to List</button>
                </div>

                <div class="card" style="padding: 20px; background: #f5f3ff; border: 1px solid #ddd6fe; margin-bottom: 24px;">
                  <div style="font-size: 0.85em; margin-bottom: 8px; font-weight: 500; color: #6d28d9;">Current Balance</div>
                  <div style="font-size: 2.5em; font-weight: 700; color: #7c3aed;" id="currentBalance">0</div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                  <button onclick="openItemModal()" class="btn btn-success">+ Add Item Sold</button>
                  <button onclick="openPaymentModal()" class="btn btn-primary">+ Give Payment</button>
                </div>

                <div style="margin-bottom: 32px;">
                  <h3 style="font-size: 1.1em; margin: 0 0 16px 0; font-weight: 600; color: #5e5873;">Items Sold (Earnings)</h3>
                  <div style="overflow-x: auto;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Item Name</th>
                          <th>Quantity</th>
                          <th>Price per Unit</th>
                          <th>Total Earned</th>
                          <th style="text-align: right;">Action</th>
                        </tr>
                      </thead>
                      <tbody id="itemsBody">
                        <tr style="text-align: center; color: #82868b;">
                          <td colspan="5">No items sold yet</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div>
                  <h3 style="font-size: 1.1em; margin: 0 0 16px 0; font-weight: 600; color: #5e5873;">Payments Given</h3>
                  <div style="overflow-x: auto;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Description</th>
                          <th>Amount</th>
                          <th style="text-align: right;">Action</th>
                        </tr>
                      </thead>
                      <tbody id="paymentsBody">
                        <tr style="text-align: center; color: #82868b;">
                          <td colspan="4">No payments given yet</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Employee Modal -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top: 0; color: #5e5873;">Add New Employee</h2>
      <div class="form-group">
        <label>First Name</label>
        <input type="text" id="firstName" class="input-field" placeholder="Enter first name">
      </div>
      <div class="form-group">
        <label>Last Name</label>
        <input type="text" id="lastName" class="input-field" placeholder="Enter last name">
      </div>
      <div class="form-group">
        <label>Position</label>
        <input type="text" id="position" class="input-field" placeholder="Enter position" optional>
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="phone" class="input-field" placeholder="Enter phone number" optional>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" class="input-field" placeholder="Enter email" optional>
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closeEmployeeModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="saveEmployee()" class="btn btn-primary">Add Employee</button>
      </div>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top: 0; color: #5e5873;">Record Item Sold</h2>
      <div class="form-group">
        <label>Item Name</label>
        <input type="text" id="itemName" class="input-field" placeholder="e.g., Phone, Laptop, etc.">
      </div>
      <div class="form-group">
        <label>Quantity Sold</label>
        <input type="number" id="itemQuantity" class="input-field" placeholder="Enter quantity" min="1">
      </div>
      <div class="form-group">
        <label>Price per Unit</label>
        <input type="number" id="itemPrice" class="input-field" placeholder="Enter price per unit" min="0" step="0.01">
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closeItemModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="saveItem()" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top: 0; color: #5e5873;">Give Payment to Employee</h2>
      <div class="form-group">
        <label>Payment Date</label>
        <input type="date" id="paymentDate" class="input-field">
      </div>
      <div class="form-group">
        <label>Amount</label>
        <input type="number" id="paymentAmount" class="input-field" placeholder="Enter amount to pay" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>Description (Optional)</label>
        <input type="text" id="paymentDescription" class="input-field" placeholder="e.g., Weekly salary, Bonus">
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closePaymentModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="savePayment()" class="btn btn-primary">Give Payment</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top: 0; color: #5e5873;">Record Item Sold</h2>
      <div class="form-group">
        <label>Item Name</label>
        <input type="text" id="productName" class="input-field" placeholder="e.g., Phone, Laptop, etc.">
      </div>
      <div class="form-group">
        <label>Quantity Sold</label>
        <input type="number" id="productQuantity" class="input-field" placeholder="Enter quantity" min="1">
      </div>
      <div class="form-group">
        <label>Price per Unit</label>
        <input type="number" id="productPrice" class="input-field" placeholder="Enter price per unit" min="0" step="0.01">
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closeProductModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="saveProduct()" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    let currentEmployeeId = null;
    let currentMonthlyEntryId = null;

    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date();
      document.getElementById('paymentDate').valueAsDate = today;
      loadEmployees();
    });

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
      if (tab === 'list') {
        loadEmployees();
      }
    }

    // Action menu management
    function openEmployeeMenu(event, employeeId) {
      event.stopPropagation();
      document.querySelectorAll('.action-menu').forEach(menu => menu.style.display = 'none');
      const menu = document.querySelector('.employee-menu-' + employeeId);
      if (menu) menu.style.display = 'block';
    }

    // Edit employee
    function editEmployee(employeeId) {
      fetch(`/api/employee/${employeeId}/`)
        .then(response => response.json())
        .then(emp => {
          document.getElementById('firstName').value = emp.first_name;
          document.getElementById('lastName').value = emp.last_name;
          document.getElementById('position').value = emp.position || '';
          document.getElementById('phone').value = emp.phone || '';
          document.getElementById('email').value = emp.email || '';
          
          const modal = document.getElementById('employeeModal');
          const h2 = modal.querySelector('h2');
          h2.textContent = 'Edit Employee';
          
          const saveBtn = modal.querySelector('button.btn-primary');
          saveBtn.onclick = () => updateEmployee(employeeId);
          
          modal.classList.add('active');
        });
    }

    // Update employee
    function updateEmployee(employeeId) {
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const position = document.getElementById('position').value;
      const phone = document.getElementById('phone').value;
      const email = document.getElementById('email').value;

      if (!firstName || !lastName) {
        alert('Please enter first and last name');
        return;
      }

      // Use update endpoint if it exists, otherwise just close and reload
      fetch(`/api/employee/${employeeId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          first_name: firstName,
          last_name: lastName,
          position: position,
          phone: phone,
          email: email
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success || data.id) {
          closeEmployeeModal();
          loadEmployees();
        } else {
          alert('Error: ' + (data.error || 'Failed to update'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating employee');
      });
    }

    // Delete employee
    function deleteEmployee(employeeId) {
      if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
        fetch(`/api/employee/${employeeId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadEmployees();
            alert('Employee deleted successfully');
          } else {
            alert('Error: ' + (data.error || 'Failed to delete'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting employee');
        });
      }
    }

    // Close menus on document click
    document.addEventListener('click', () => {
      document.querySelectorAll('.action-menu').forEach(menu => menu.style.display = 'none');
    });

    function loadEmployees() {
      fetch('/api/employees/')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('employeesBody');
          if (data.employees.length === 0) {
            tbody.innerHTML = '<tr style="text-align: center; color: #82868b;"><td colspan="4">No employees yet</td></tr>';
            return;
          }

          tbody.innerHTML = data.employees.map(emp => `
            <tr onclick="viewEmployee(${emp.id})" style="cursor: pointer;">
              <td style="font-weight: 500;">${emp.first_name} ${emp.last_name}</td>
              <td>${emp.position || '-'}</td>
              <td>
                <span style="font-weight: 600; color: #7c3aed;">Loading...</span>
              </td>
              <td style="position: relative; text-align: center;">
                <button onclick="openEmployeeMenu(event, ${emp.id})" class="btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0;">⋮</button>
                <div class="action-menu employee-menu-${emp.id}" style="display: none;">
                  <button onclick="viewEmployee(${emp.id})">View</button>
                  <button onclick="editEmployee(${emp.id})">Edit</button>
                  <button onclick="deleteEmployee(${emp.id})">Delete</button>
                </div>
              </td>
            </tr>
          `).join('');

          // Load balance for each employee
          data.employees.forEach(emp => {
            loadEmployeeBalance(emp.id);
          });
        })
        .catch(error => console.error('Error:', error));
    }

    function loadEmployeeBalance(employeeId) {
      fetch(`/api/monthly/entries/?employee_id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
          const rows = document.querySelectorAll('tbody#employeesBody tr');
          rows.forEach((row) => {
            // Get employee ID from the row's view button (data attribute or parse from onclick)
            const viewBtn = row.querySelector('button[onclick*="viewEmployee"]');
            if (viewBtn) {
              const btnOnclick = viewBtn.getAttribute('onclick');
              const rowEmployeeId = parseInt(btnOnclick.match(/\d+/)[0]);
              
              // Only update this row if it matches the current employee
              if (rowEmployeeId === employeeId) {
                const balanceCell = row.querySelector('td:nth-child(3)');
                if (data.entries.length > 0) {
                  balanceCell.innerHTML = `<span style="font-weight: 600; color: #7c3aed;">${parseFloat(data.entries[0].balance).toFixed(2)} sum</span>`;
                } else {
                  balanceCell.innerHTML = `<span style="font-weight: 600; color: #7c3aed;">0 sum</span>`;
                }
              }
            }
          });
        })
        .catch(error => console.error('Error:', error));
    }

    function viewEmployee(employeeId) {
      currentEmployeeId = employeeId;
      
      // Get employee details
      fetch(`/api/employee/${employeeId}/`)
        .then(response => response.json())
        .then(emp => {
          document.getElementById('employeeDetailName').textContent = `${emp.first_name} ${emp.last_name}`;
          document.getElementById('employeeDetailPosition').textContent = emp.position || 'Position not set';
        });

      // Get or create monthly entry
      fetch(`/api/monthly/entries/?employee_id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
          if (data.entries.length > 0) {
            currentMonthlyEntryId = data.entries[0].id;
            updateEmployeeDetail(data.entries[0]);
          } else {
            // Create entry if doesn't exist
            const today = new Date();
            const monthDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
            
            fetch('/api/monthly/entry/create/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({
                employee_id: employeeId,
                month: monthDate
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                currentMonthlyEntryId = data.id;
                viewEmployee(employeeId);
              }
            });
          }
        });

      // Show details and switch tab
      document.getElementById('employeeDetailsContent').style.display = 'block';
      document.getElementById('details').classList.add('active');
      document.getElementById('list').classList.remove('active');
      document.querySelectorAll('.tab-btn')[1].classList.add('active');
      document.querySelectorAll('.tab-btn')[0].classList.remove('active');
    }

    function updateEmployeeDetail(entry) {
      document.getElementById('currentBalance').textContent = parseFloat(entry.balance).toFixed(2) + ' sum';
      
      fetch(`/api/monthly/entry/${entry.id}/`)
        .then(response => response.json())
        .then(data => {
          updateItemsTable(data.products);
          updatePaymentsTable(data.payments);
        });
    }

    function updateItemsTable(items) {
      const tbody = document.getElementById('itemsBody');
      if (items.length === 0) {
        tbody.innerHTML = '<tr style="text-align: center; color: #82868b;"><td colspan="5">No items sold yet</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(item => `
        <tr>
          <td>${item.product_name}</td>
          <td>${item.quantity}</td>
          <td>${parseFloat(item.price_per_unit).toFixed(2)}</td>
          <td>${parseFloat(item.total_amount).toFixed(2)}</td>
          <td style="text-align: right;">
            <button onclick="deleteItem(${item.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85em;">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function updatePaymentsTable(payments) {
      const tbody = document.getElementById('paymentsBody');
      if (payments.length === 0) {
        tbody.innerHTML = '<tr style="text-align: center; color: #82868b;"><td colspan="4">No payments given yet</td></tr>';
        return;
      }

      tbody.innerHTML = payments.map(payment => `
        <tr>
          <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
          <td>${payment.description || '-'}</td>
          <td>${parseFloat(payment.amount).toFixed(2)}</td>
          <td style="text-align: right;">
            <button onclick="deletePayment(${payment.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85em;">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function closeEmployeeDetail() {
      document.getElementById('employeeDetailsContent').style.display = 'none';
      document.getElementById('list').classList.add('active');
      document.getElementById('details').classList.remove('active');
      document.querySelectorAll('.tab-btn')[0].classList.add('active');
      document.querySelectorAll('.tab-btn')[1].classList.remove('active');
      currentEmployeeId = null;
      currentMonthlyEntryId = null;
      loadEmployees();
    }

    function openEmployeeModal() {
      const modal = document.getElementById('employeeModal');
      const h2 = modal.querySelector('h2');
      h2.textContent = 'Add New Employee';
      
      const saveBtn = modal.querySelector('button.btn-primary');
      saveBtn.onclick = () => saveEmployee();
      
      modal.classList.add('active');
    }

    function closeEmployeeModal() {
      document.getElementById('employeeModal').classList.remove('active');
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('position').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('email').value = '';
      
      // Reset modal title and button
      const modal = document.getElementById('employeeModal');
      const h2 = modal.querySelector('h2');
      h2.textContent = 'Add New Employee';
      
      const saveBtn = modal.querySelector('button.btn-primary');
      saveBtn.onclick = () => saveEmployee();
    }

    function saveEmployee() {
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const position = document.getElementById('position').value;
      const phone = document.getElementById('phone').value;
      const email = document.getElementById('email').value;

      if (!firstName || !lastName) {
        alert('Please enter first and last name');
        return;
      }

      fetch('/api/employee/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          first_name: firstName,
          last_name: lastName,
          position: position,
          phone: phone,
          email: email,
          is_active: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Employee added successfully');
          closeEmployeeModal();
          loadEmployees();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => console.error('Error:', error));
    }

    function openItemModal() {
      if (!currentMonthlyEntryId) {
        alert('Please select an employee first');
        return;
      }
      document.getElementById('itemModal').classList.add('active');
    }

    function closeItemModal() {
      document.getElementById('itemModal').classList.remove('active');
      document.getElementById('itemName').value = '';
      document.getElementById('itemQuantity').value = '';
      document.getElementById('itemPrice').value = '';
    }

    function saveItem() {
      const itemName = document.getElementById('itemName').value;
      const quantity = document.getElementById('itemQuantity').value;
      const price = document.getElementById('itemPrice').value;

      if (!itemName || !quantity || !price) {
        alert('Please fill in all fields');
        return;
      }

      fetch('/api/monthly/product/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          entry_id: currentMonthlyEntryId,
          product_name: itemName,
          quantity: parseInt(quantity),
          price_per_unit: parseFloat(price)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeItemModal();
          document.getElementById('currentBalance').textContent = parseFloat(data.new_balance).toFixed(2) + ' sum';
          viewEmployee(currentEmployeeId);
          loadEmployees();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => console.error('Error:', error));
    }

    function openPaymentModal() {
      if (!currentMonthlyEntryId) {
        alert('Please select an employee first');
        return;
      }
      document.getElementById('paymentModal').classList.add('active');
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').classList.remove('active');
      document.getElementById('paymentDate').valueAsDate = new Date();
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentDescription').value = '';
    }

    function savePayment() {
      const amount = document.getElementById('paymentAmount').value;
      const description = document.getElementById('paymentDescription').value;
      const paymentDate = document.getElementById('paymentDate').value;

      if (!amount || !paymentDate) {
        alert('Please fill in required fields');
        return;
      }

      fetch('/api/monthly/payment/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          entry_id: currentMonthlyEntryId,
          amount: parseFloat(amount),
          description: description,
          payment_date: paymentDate
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closePaymentModal();
          document.getElementById('currentBalance').textContent = parseFloat(data.new_balance).toFixed(2) + ' sum';
          viewEmployee(currentEmployeeId);
          loadEmployees();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => console.error('Error:', error));
    }

    function deleteItem(itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/api/monthly/product/${itemId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('currentBalance').textContent = parseFloat(data.new_balance).toFixed(2) + ' sum';
            viewEmployee(currentEmployeeId);
            loadEmployees();
          }
        })
        .catch(error => console.error('Error:', error));
      }
    }

    function deletePayment(paymentId) {
      if (confirm('Are you sure you want to delete this payment?')) {
        fetch(`/api/monthly/payment/${paymentId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('currentBalance').textContent = parseFloat(data.new_balance).toFixed(2) + ' sum';
            viewEmployee(currentEmployeeId);
            loadEmployees();
          }
        })
        .catch(error => console.error('Error:', error));
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
